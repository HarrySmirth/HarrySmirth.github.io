{{ define "main" }}
{{- $writeups := where site.RegularPages "Section" "writeups" -}}
{{- $total := len $writeups -}}

{{- /* Platform counts */ -}}
{{- $thm := 0 -}}
{{- $htb := 0 -}}
{{- range $writeups -}}
  {{- $path := .File.Dir -}}
  {{- if findRE "tryhackme" $path -}}{{ $thm = add $thm 1 }}
  {{- else if findRE "hackthebox" $path -}}{{ $htb = add $htb 1 }}
  {{- end -}}
{{- end -}}

{{- /* Difficulty counts */ -}}
{{- $easy := 0 -}}{{ $medium := 0 -}}{{ $hard := 0 -}}{{ $insane := 0 -}}
{{- range $writeups -}}
  {{- range (.Params.tags | default slice) -}}
    {{- $t := . | lower -}}
    {{- if eq $t "easy" }}{{ $easy = add $easy 1 }}
    {{- else if eq $t "medium" }}{{ $medium = add $medium 1 }}
    {{- else if eq $t "hard" }}{{ $hard = add $hard 1 }}
    {{- else if eq $t "insane" }}{{ $insane = add $insane 1 }}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Technique counts for radar chart */ -}}
{{- $techWeb := 0 -}}{{ $techPrivesc := 0 -}}{{ $techNetwork := 0 -}}
{{- $techCrypto := 0 -}}{{ $techForensics := 0 -}}{{ $techRE := 0 -}}
{{- $webTags := slice "web" "xss" "sqli" "sql-injection" "lfi" "rfi" "ssrf" "file-upload" "web-exploitation" "xxe" "command-injection" -}}
{{- $privescTags := slice "privilege-escalation" "privesc" "suid" "sudo" "kernel" "linpeas" "winpeas" -}}
{{- $networkTags := slice "network" "pivoting" "port-forwarding" "tunneling" "smb" "ftp" "ssh" "dns" -}}
{{- $cryptoTags := slice "crypto" "cryptography" "encryption" "hash" "rsa" "aes" -}}
{{- $forensicsTags := slice "forensics" "steganography" "stego" "pcap" "memory" "disk" -}}
{{- $reTags := slice "reverse-engineering" "reversing" "binary" "ghidra" "gdb" "buffer-overflow" "bof" -}}

{{- range $writeups -}}
  {{- $tags := .Params.tags | default slice -}}
  {{- $countedWeb := false -}}{{ $countedPrivesc := false -}}{{ $countedNetwork := false -}}
  {{- $countedCrypto := false -}}{{ $countedForensics := false -}}{{ $countedRE := false -}}
  {{- range $tags -}}
    {{- $t := . | lower -}}
    {{- if not $countedWeb }}{{ range $webTags }}{{ if eq $t . }}{{ $techWeb = add $techWeb 1 }}{{ $countedWeb = true }}{{ end }}{{ end }}{{ end -}}
    {{- if not $countedPrivesc }}{{ range $privescTags }}{{ if eq $t . }}{{ $techPrivesc = add $techPrivesc 1 }}{{ $countedPrivesc = true }}{{ end }}{{ end }}{{ end -}}
    {{- if not $countedNetwork }}{{ range $networkTags }}{{ if eq $t . }}{{ $techNetwork = add $techNetwork 1 }}{{ $countedNetwork = true }}{{ end }}{{ end }}{{ end -}}
    {{- if not $countedCrypto }}{{ range $cryptoTags }}{{ if eq $t . }}{{ $techCrypto = add $techCrypto 1 }}{{ $countedCrypto = true }}{{ end }}{{ end }}{{ end -}}
    {{- if not $countedForensics }}{{ range $forensicsTags }}{{ if eq $t . }}{{ $techForensics = add $techForensics 1 }}{{ $countedForensics = true }}{{ end }}{{ end }}{{ end -}}
    {{- if not $countedRE }}{{ range $reTags }}{{ if eq $t . }}{{ $techRE = add $techRE 1 }}{{ $countedRE = true }}{{ end }}{{ end }}{{ end -}}
  {{- end -}}
{{- end -}}

{{- /* Monthly timeline data */ -}}
{{- $monthMap := dict -}}
{{- range $writeups -}}
  {{- $key := .Date.Format "2006-01" -}}
  {{- $cur := index $monthMap $key | default 0 -}}
  {{- $monthMap = merge $monthMap (dict $key (add $cur 1)) -}}
{{- end -}}
{{- $sortedMonths := slice -}}
{{- range $k, $v := $monthMap -}}
  {{- $sortedMonths = $sortedMonths | append (dict "month" $k "count" $v) -}}
{{- end -}}
{{- $sortedMonths = sort $sortedMonths "month" -}}

{{- /* Writeup dates for streak calc (sorted ascending) */ -}}
{{- $dateList := slice -}}
{{- range $writeups -}}
  {{- $dateList = $dateList | append (.Date.Format "2006-01-02") -}}
{{- end -}}
{{- $dateList = sort $dateList -}}

{{- /* Time to Pwn data */ -}}
{{- $ttpData := slice -}}
{{- range (sort $writeups "Date") -}}
  {{- $tt := .Params.time_taken | default "" -}}
  {{- if $tt -}}
    {{- $difficulty := "unknown" -}}
    {{- range (.Params.tags | default slice) -}}
      {{- $t := . | lower -}}
      {{- if or (eq $t "easy") (eq $t "medium") (eq $t "hard") (eq $t "insane") }}{{ $difficulty = $t }}{{ end -}}
    {{- end -}}
    {{- $ttpData = $ttpData | append (dict "title" .Title "time" $tt "difficulty" $difficulty) -}}
  {{- end -}}
{{- end -}}

<header class="page-header">
  {{- partial "breadcrumbs.html" . }}
  <h1>{{ .Title }}</h1>
  {{- if .Description }}
  <div class="post-description">{{ .Description }}</div>
  {{- end }}
</header>

<div class="stats-page">
  <div class="stats-page-summary">
    <div class="stats-page-grid">
      <div class="stat-card">
        <span class="stat-number" data-target="{{ $total }}">0</span>
        <span class="stat-label">Total Writeups</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" data-target="{{ $thm }}">0</span>
        <span class="stat-label">TryHackMe</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" data-target="{{ $htb }}">0</span>
        <span class="stat-label">HackTheBox</span>
      </div>
      <div class="stat-card easy">
        <span class="stat-number" data-target="{{ $easy }}">0</span>
        <span class="stat-label">Easy</span>
      </div>
      <div class="stat-card medium">
        <span class="stat-number" data-target="{{ $medium }}">0</span>
        <span class="stat-label">Medium</span>
      </div>
      <div class="stat-card hard">
        <span class="stat-number" data-target="{{ $hard }}">0</span>
        <span class="stat-label">Hard</span>
      </div>
    </div>
  </div>

  {{- /* Streak Tracker */ -}}
  <div class="streak-container">
    <div class="streak-header"><span class="streak-prompt">$</span> streak --stats</div>
    <div class="streak-body" id="streak-body">
      <div class="streak-line"><span class="streak-flag">--current:</span> <span id="streak-current">0 days</span></div>
      <div class="streak-line"><span class="streak-flag">--longest:</span> <span id="streak-longest">0 days</span></div>
      <div class="streak-line"><span class="streak-flag">--last-active:</span> <span id="streak-last">N/A</span></div>
    </div>
  </div>
  <script>
  (function(){
    var dates = [{{ range $i, $d := $dateList }}{{ if $i }},{{ end }}'{{ $d }}'{{ end }}];
    if (!dates.length) return;
    // Deduplicate and sort
    var unique = [];
    var seen = {};
    dates.forEach(function(d){ if(!seen[d]){ seen[d]=true; unique.push(d); } });
    unique.sort();

    // Calculate streaks (consecutive days)
    var current = 1;
    var longest = 1;
    var streak = 1;
    var today = new Date();
    today.setHours(0,0,0,0);
    var lastDate = new Date(unique[unique.length - 1] + 'T00:00:00');

    for (var i = unique.length - 1; i > 0; i--) {
      var d1 = new Date(unique[i] + 'T00:00:00');
      var d2 = new Date(unique[i-1] + 'T00:00:00');
      var diff = (d1 - d2) / 86400000;
      if (diff === 1) {
        streak++;
      } else {
        if (streak > longest) longest = streak;
        streak = 1;
      }
    }
    if (streak > longest) longest = streak;

    // Current streak: count back from most recent date
    current = 1;
    for (var j = unique.length - 1; j > 0; j--) {
      var a = new Date(unique[j] + 'T00:00:00');
      var b = new Date(unique[j-1] + 'T00:00:00');
      if ((a - b) / 86400000 === 1) {
        current++;
      } else {
        break;
      }
    }

    // If last active date is more than 1 day ago, current streak is 0
    var daysSinceLast = Math.floor((today - lastDate) / 86400000);
    if (daysSinceLast > 1) current = 0;

    document.getElementById('streak-current').textContent = current + ' day' + (current !== 1 ? 's' : '');
    document.getElementById('streak-longest').textContent = longest + ' day' + (longest !== 1 ? 's' : '');
    document.getElementById('streak-last').textContent = unique[unique.length - 1];
  })();
  </script>

  <div class="charts-grid">
    <div class="chart-container">
      <h2>Platform Distribution</h2>
      <div class="chart-wrap">
        <canvas id="chart-platform"></canvas>
      </div>
    </div>
    <div class="chart-container">
      <h2>Difficulty Breakdown</h2>
      <div class="chart-wrap">
        <canvas id="chart-difficulty"></canvas>
      </div>
    </div>
    <div class="chart-container chart-wide">
      <h2>Writeups Over Time</h2>
      <div class="chart-wrap chart-wrap-wide">
        <canvas id="chart-timeline"></canvas>
      </div>
    </div>
    <div class="chart-container">
      <h2>Technique Coverage</h2>
      <div class="chart-wrap">
        <canvas id="chart-techniques"></canvas>
      </div>
    </div>
  </div>

  {{- /* Time to Pwn chart */ -}}
  {{- if $ttpData }}
  <div class="chart-container chart-wide ttp-container">
    <h2>Time to Pwn</h2>
    <div class="chart-wrap chart-wrap-wide">
      <canvas id="chart-ttp"></canvas>
    </div>
  </div>
  {{- end }}

  {{- /* Completion Heatmap â€” GitHub-style contribution calendar */ -}}
  {{- $dateCounts := dict -}}
  {{- range $writeups -}}
    {{- $d := .Date.Format "2006-01-02" -}}
    {{- $cur := index $dateCounts $d | default 0 -}}
    {{- $dateCounts = merge $dateCounts (dict $d (add $cur 1)) -}}
  {{- end -}}
  <div class="heatmap-container">
    <h2>git log --format='%ad' --date=short | uniq -c</h2>
    <div class="heatmap-scroll">
      <div class="heatmap-grid" id="heatmap-grid"></div>
    </div>
    <div class="heatmap-labels" id="heatmap-labels"></div>
    <div class="heatmap-legend">
      <span>Less</span>
      <span class="heatmap-legend-cell" style="background:var(--bg-card)"></span>
      <span class="heatmap-legend-cell" style="background:rgba(0,255,65,0.25)"></span>
      <span class="heatmap-legend-cell" style="background:rgba(0,255,65,0.45)"></span>
      <span class="heatmap-legend-cell" style="background:rgba(0,255,65,0.65)"></span>
      <span class="heatmap-legend-cell" style="background:rgba(0,255,65,0.85)"></span>
      <span>More</span>
    </div>
  </div>
  <script>
  (function(){
    var dateCounts = { {{ range $k, $v := $dateCounts }}'{{ $k }}': {{ $v }},{{ end }} };
    var grid = document.getElementById('heatmap-grid');
    var labels = document.getElementById('heatmap-labels');
    if (!grid) return;

    var today = new Date();
    today.setHours(0,0,0,0);
    var start = new Date(today);
    start.setDate(start.getDate() - 363);
    var dayOfWeek = start.getDay();
    start.setDate(start.getDate() - dayOfWeek);

    var tooltip = document.createElement('div');
    tooltip.className = 'heatmap-tooltip';
    tooltip.style.display = 'none';
    document.body.appendChild(tooltip);

    var monthPositions = {};
    var d = new Date(start);

    while (d <= today) {
      var key = d.toISOString().slice(0, 10);
      var count = dateCounts[key] || 0;
      var cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      if (count > 0) {
        cell.setAttribute('data-count', Math.min(count, 5));
        if (count > 4) cell.classList.add('heatmap-high');
      }
      cell.setAttribute('data-date', key);
      cell.setAttribute('title', key + ': ' + count + ' writeup' + (count !== 1 ? 's' : ''));

      cell.addEventListener('mouseenter', function(e) {
        var c = dateCounts[this.getAttribute('data-date')] || 0;
        tooltip.textContent = this.getAttribute('data-date') + ': ' + c + ' writeup' + (c !== 1 ? 's' : '');
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 10) + 'px';
        tooltip.style.top = (e.clientY - 30) + 'px';
      });
      cell.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });

      var mon = d.getMonth();
      var weekCol = Math.floor((d - start) / (7 * 86400000));
      var monKey = d.getFullYear() + '-' + mon;
      if (!monthPositions[monKey]) {
        monthPositions[monKey] = { col: weekCol, label: d.toLocaleString('en', { month: 'short' }) };
      }

      grid.appendChild(cell);
      d.setDate(d.getDate() + 1);
    }

    Object.keys(monthPositions).sort().forEach(function(k) {
      var info = monthPositions[k];
      var span = document.createElement('span');
      span.textContent = info.label;
      span.style.position = 'absolute';
      span.style.left = (info.col * 17) + 'px';
      labels.appendChild(span);
    });
    labels.style.position = 'relative';
    labels.style.height = '16px';
  })();
  </script>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
(function() {
  var green = '#00ff41';
  var cyan = '#00b4d8';
  var orange = '#ff9f43';
  var red = '#ff4757';
  var purple = '#a855f7';
  var muted = '#484f58';
  var gridColor = 'rgba(48, 54, 61, 0.6)';

  Chart.defaults.color = '#8b949e';
  Chart.defaults.font.family = "'JetBrains Mono', monospace";
  Chart.defaults.font.size = 11;

  // Platform doughnut
  new Chart(document.getElementById('chart-platform'), {
    type: 'doughnut',
    data: {
      labels: ['TryHackMe', 'HackTheBox'],
      datasets: [{
        data: [{{ $thm }}, {{ $htb }}],
        backgroundColor: [green, cyan],
        borderColor: '#0d1117',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 16 } }
      }
    }
  });

  // Difficulty bar chart
  new Chart(document.getElementById('chart-difficulty'), {
    type: 'bar',
    data: {
      labels: ['Easy', 'Medium', 'Hard', 'Insane'],
      datasets: [{
        label: 'Writeups',
        data: [{{ $easy }}, {{ $medium }}, {{ $hard }}, {{ $insane }}],
        backgroundColor: [green, orange, red, purple],
        borderColor: [green, orange, red, purple],
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          grid: { color: gridColor }
        },
        x: { grid: { display: false } }
      }
    }
  });

  // Timeline line chart
  var monthLabels = [{{ range $i, $m := $sortedMonths }}{{ if $i }},{{ end }}'{{ $m.month }}'{{ end }}];
  var monthData = [{{ range $i, $m := $sortedMonths }}{{ if $i }},{{ end }}{{ $m.count }}{{ end }}];

  var cumulative = [];
  var sum = 0;
  for (var i = 0; i < monthData.length; i++) {
    sum += monthData[i];
    cumulative.push(sum);
  }

  new Chart(document.getElementById('chart-timeline'), {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'Cumulative Writeups',
        data: cumulative,
        borderColor: green,
        backgroundColor: 'rgba(0, 255, 65, 0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: green,
        pointBorderColor: '#0d1117',
        pointBorderWidth: 2,
        pointRadius: 4
      }, {
        label: 'Monthly',
        data: monthData,
        borderColor: cyan,
        backgroundColor: 'rgba(0, 180, 216, 0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: cyan,
        pointBorderColor: '#0d1117',
        pointBorderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { padding: 16 } } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          grid: { color: gridColor }
        },
        x: { grid: { color: gridColor } }
      }
    }
  });

  // Technique radar
  new Chart(document.getElementById('chart-techniques'), {
    type: 'radar',
    data: {
      labels: ['Web', 'Priv Esc', 'Network', 'Crypto', 'Forensics', 'Rev Eng'],
      datasets: [{
        label: 'Writeups',
        data: [{{ $techWeb }}, {{ $techPrivesc }}, {{ $techNetwork }}, {{ $techCrypto }}, {{ $techForensics }}, {{ $techRE }}],
        borderColor: cyan,
        backgroundColor: 'rgba(0, 180, 216, 0.15)',
        pointBackgroundColor: cyan,
        pointBorderColor: '#0d1117',
        pointBorderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        r: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: muted, backdropColor: 'transparent' },
          grid: { color: gridColor },
          angleLines: { color: gridColor },
          pointLabels: { color: '#8b949e', font: { size: 11 } }
        }
      }
    }
  });

  // Time to Pwn bar chart
  var ttpCanvas = document.getElementById('chart-ttp');
  if (ttpCanvas) {
    var ttpRaw = [{{ range $i, $d := $ttpData }}{{ if $i }},{{ end }}{ t: '{{ $d.title }}', time: '{{ $d.time }}', diff: '{{ $d.difficulty }}' }{{ end }}];
    var diffColors = { easy: green, medium: orange, hard: red, insane: purple, unknown: muted };

    function parseTime(str) {
      var mins = 0;
      var h = str.match(/(\d+)\s*h/i);
      var m = str.match(/(\d+)\s*m/i);
      if (h) mins += parseInt(h[1], 10) * 60;
      if (m) mins += parseInt(m[1], 10);
      if (!h && !m) {
        var n = parseInt(str, 10);
        if (!isNaN(n)) mins = n;
      }
      return mins;
    }

    var ttpLabels = [];
    var ttpValues = [];
    var ttpColors = [];
    ttpRaw.forEach(function(d) {
      var mins = parseTime(d.time);
      if (mins > 0) {
        ttpLabels.push(d.t.length > 20 ? d.t.slice(0, 18) + '..' : d.t);
        ttpValues.push(mins);
        ttpColors.push(diffColors[d.diff] || muted);
      }
    });

    if (ttpValues.length > 0) {
      new Chart(ttpCanvas, {
        type: 'bar',
        data: {
          labels: ttpLabels,
          datasets: [{
            label: 'Minutes',
            data: ttpValues,
            backgroundColor: ttpColors,
            borderColor: ttpColors,
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              title: { display: true, text: 'Minutes', color: '#8b949e' },
              grid: { color: gridColor }
            },
            y: {
              grid: { display: false },
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
    }
  }
})();
</script>
{{ end }}
